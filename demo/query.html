<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>Request query demo</title>

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../web-animations-js/web-animations-next.min.js"></script>

  <script type="module" src="../../../@webcomponents/shadycss/entrypoints/apply-shim.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/elements/custom-style.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/elements/dom-bind.js"></script>
  <script type="module" src="../../../@advanced-rest-client/arc-demo-helper/src/arc-demo-helper.js"></script>
  <script type="module" src="../../../@polymer/paper-input/paper-input.js"></script>
  <script type="module" src="../../../@polymer/paper-button/paper-button.js"></script>
  <script type="module" src="../../../@polymer/paper-checkbox/paper-checkbox.js"></script>
  <script type="module" src="../../../@polymer/paper-toast/paper-toast.js"></script>
  <script type="module" src="../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js"></script>
  <script type="module" src="../../../@polymer/paper-item/paper-item.js"></script>
  <script type="module" src="../../../@polymer/paper-listbox/paper-listbox.js"></script>
  <script type="module" src="../../../@polymer/paper-styles/shadow.js"></script>
  <script type="module" src="../request-model.js"></script>
  <script type="module" src="../project-model.js"></script>
  <script type="module" src="../url-indexer.js"></script>
  <!-- <script src="../../../pouchdb/dist/pouchdb.js"></script> -->
  <script src="../../../pouchdb-quick-search/dist/pouchdb.quick-search.js"></script>
  <custom-style>
    <style is="custom-style">
    :root {
      --arc-font-body1: {
        @apply --paper-font-body1;
      }
    }

    h1 {
      @apply --paper-font-headline;
    }

    h2 {
      @apply --paper-font-title;
    }

    .card {
      @apply --shadow-elevation-3dp;
      margin-top: 12px;
      margin-bottom: 12px;
      background-color: #fff;
      padding: 12px;
    }

    .search-box {
      @apply --layout-horizontal;
    }

    .search-box paper-input {
      @apply --layout-flex;
    }
    </style>
  </custom-style>
</head>
<body>
  <header>
    <h1>Query model demo</h1>
  </header>
  <dom-bind id="demo">
    <template is="dom-bind">
      <request-model id="rModel"></request-model>
      <project-model id="pModel"></project-model>
      <url-indexer on-request-indexing-finished="_indexFinished"></url-indexer>

      <section class="card centered options">
        <h2>Data options</h2>
        <paper-button on-click="generateData">Generate data</paper-button>
        <paper-button on-click="deleteData">Destroy data</paper-button>
        <paper-button on-click="forceIndex">Force PouchDB index</paper-button>
      </section>

      <section class="card centered options">
        <h2>Search options</h2>
        <paper-dropdown-menu label="Request type">
          <paper-listbox slot="dropdown-content" selected="{{requestType}}">
            <paper-item>History and saved</paper-item>
            <paper-item>History only</paper-item>
            <paper-item>Saved only</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <div>
          <paper-checkbox checked="{{detailedSearch}}">Perform detailed search</paper-checkbox>
        </div>
      </section>

      <section class="centered card" role="main">
        <h2>Search data store</h2>
        <div class="search-box">
          <paper-input label="Search term" id="q" name="q" value="{{q}}"></paper-input>
          <paper-button on-click="search">Search</paper-button>
        </div>
      </section>

      <template is="dom-if" if="[[hasResults]]">
        <section class="centered card" role="main">
          <h2>Search Results ([[results.length]])</h2>
          <template is="dom-repeat" items="[[results]]">
            <p>[[index]]: [[item._id]], [[item.type]]</p>
          </template>
        </section>
      </template>

    </template>
  </dom-bind>
  <paper-toast text="Data is indexed" id="indexOk"></paper-toast>
  <paper-toast text="Datastore cleared" id="deleteOk"></paper-toast>
  <paper-toast text="Datastore indexed" id="indexedOk"></paper-toast>
  <script type="module">
    import {DataGenerator} from '../../../@advanced-rest-client/arc-data-generator/arc-data-generator.js';
    /* global PouchDB, PouchQuickSearch */
    // PouchDB is imported by the generator
    // PouchQuickSearch is included into the page as a regular script as it doesn't export anything for ES6 modules
    // and therefore it cannot be loaded here (it produces errors as some variable is not defined
    // and modules always work in strict mode).
    // This is a hack to make it all work.
    // TODO: (pawel) Consider creating own IDB adapter as maitainers of PouchDB are
    // not very cooperative.
    PouchDB.plugin(PouchQuickSearch);
    (function(scope) {
      scope.q = 'api';
      scope.requestType = 0;
      scope.hasResults = false;

      scope.generateData = function() {
        console.log('Generating data.');
        scope.generateHistory()
        .then(() => scope.generateSaved());
      };

      scope.generateHistory = function() {
        const data = DataGenerator.generateHistoryRequestsData({
          requestsSize: 100
        });
        console.log('Inserting Requests.');
        performance.mark('requests-inserts-start');
        const rModel = document.getElementById('rModel');
        return rModel.updateBulk('history', data)
        .then(() => {
          performance.mark('indexing-start');
          console.log('Data inserted');
          performance.mark('requests-inserts-end');
          performance.measure('requests-inserts-end', 'requests-inserts-start');
          scope._dumpMeasurements();
        })
        .catch((cause) => {
          console.log(cause);
          scope._dumpMeasurements();
        });
      };

      scope.generateSaved = function() {
        const data = DataGenerator.generateSavedRequestData({
          projectsSize: 25,
          requestsSize: 100
        });
        performance.mark('projects-inserts-start');
        const rModel = document.getElementById('rModel');
        const pModel = document.getElementById('pModel');
        console.log('Inserting projects.');
        pModel.updateBulk(data.projects)
        .then(() => {
          performance.mark('projects-inserts-end');
          performance.measure('projects-inserts-end', 'projects-inserts-start');
          console.log('Projects ready. Inserting Requests.');
          performance.mark('requests-inserts-start');
          return rModel.updateBulk('saved', data.requests);
        })
        .then(() => {
          performance.mark('indexing-start');
          console.log('Data inserted');
          performance.mark('requests-inserts-end');
          performance.measure('requests-inserts-end', 'requests-inserts-start');
          scope._dumpMeasurements();
        })
        .catch((cause) => {
          console.log(cause);
          scope._dumpMeasurements();
        });
      };

      scope._dumpMeasurements = function() {
        const ms = performance.getEntriesByType('measure');
        console.table(ms.map((item) => {
          return {
            name: item.name,
            duration: item.duration
          };
        }));
        performance.clearMeasures();
      };

      scope._indexFinished = function() {
        performance.mark('inserts-end');
        performance.measure('inserts-end', 'inserts-start');
        console.log('Indexing finished');
        scope._dumpMeasurements();
        document.getElementById('indexOk').opened = true;
      };

      scope.deleteData = function() {
        // const indexer = new RequestDb();
        // return indexer.openSearchStore()
        // .then((db) => {
        //   return new Promise((resolve, reject) => {
        //     const tx = db.transaction('urls', 'readwrite');
        //     const store = tx.objectStore('urls');
        //     const results = [];
        //     tx.onerror = () => {
        //       reject(results);
        //     };
        //     tx.oncomplete = () => {
        //       resolve(results);
        //     };
        //     store.clear();
        //   });
        // })
        // .then(() => {
        //   document.getElementById('deleteOk').opened = true;
        // });
      };

      scope.search = function() {
        const detail = {
          q: scope.q
        };
        switch (scope.requestType) {
          case 1: detail.type = 'history'; break;
          case 2: detail.type = 'saved'; break;
        }
        if (scope.detailedSearch) {
          detail.detailed = true;
        }
        const e = new CustomEvent('request-query', {
          cancelable: true,
          bubbles: true,
          detail
        });
        performance.mark('data-search');
        document.body.dispatchEvent(e);
        e.detail.result
        .then((data) => {
          performance.mark('data-search-end');
          performance.measure('data-search-end', 'data-search');
          scope._dumpMeasurements();
          console.log('Query result', data);
          scope.results = data;
          scope.hasResults = true;
        });
      };

      scope.forceIndex = function() {
        const model = document.getElementById('model');
        performance.mark('index-history');
        model.indexData('history')
        .then(() => {
          performance.mark('index-history-end');
          performance.measure('index-history-end', 'index-history');
          performance.mark('index-saved');
          return model.indexData('saved');
        })
        .then(() => {
          performance.mark('index-saved-end');
          performance.measure('index-saved-end', 'index-saved');
          scope._dumpMeasurements();
          document.getElementById('indexedOk').opened = true;
        });
      };
    })(document.getElementById('demo'));
  </script>
</body>
</html>
