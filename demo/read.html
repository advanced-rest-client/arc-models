<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>Request read demo</title>
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script type="module" src="../../../@webcomponents/shadycss/entrypoints/apply-shim.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/elements/custom-style.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/elements/dom-bind.js"></script>
  <script type="module" src="../../../@polymer/iron-demo-helpers/demo-pages-shared-styles.js"></script>
  <script type="module" src="../../../@polymer/paper-input/paper-input.js"></script>
  <script type="module" src="../../../@polymer/paper-button/paper-button.js"></script>
  <script type="module" src="../../../@polymer/paper-checkbox/paper-checkbox.js"></script>
  <script type="module" src="../../../@polymer/paper-toast/paper-toast.js"></script>
  <script type="module" src="../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js"></script>
  <script type="module" src="../../../@polymer/paper-item/paper-item.js"></script>
  <script type="module" src="../../../@polymer/paper-listbox/paper-listbox.js"></script>
  <script type="module" src="../../../@polymer/neon-animation/web-animations.js"></script>
  <script type="module" src="../../../app-pouchdb/pouchdb.js"></script>
  <script type="module" src="../../../@polymer/paper-styles/shadow.js"></script>
  <script type="module" src="../../../@polymer/iron-form/iron-form.js"></script>
  <script type="module" src="../request-model.js"></script>
  <script src="../../../chance/chance.js"></script>
  <!-- FIXME(polymer-modulizer):
        These imperative modules that innerHTML your HTML are
        a hacky way to be sure that any mixins in included style
        modules are ready before any elements that reference them are
        instantiated, otherwise the CSS @apply mixin polyfill won't be
        able to expand the underlying CSS custom properties.
        See: https://github.com/Polymer/polymer-modulizer/issues/154
        -->
    <script type="module">
const $_documentContainer = document.createElement('template');

$_documentContainer.innerHTML = `<custom-style>
    <style is="custom-style" include="demo-pages-shared-styles">
    :root {
      --arc-font-body1: {
        @apply --paper-font-body1;
      }
    }

    h1 {
      @apply --paper-font-headline;
    }

    h2 {
      @apply --paper-font-title;
    }

    .card {
      @apply --shadow-elevation-3dp;
      margin-top: 12px;
      margin-bottom: 12px;
      background-color: #fff;
      padding: 12px;
    }

    .form-item {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .form-item paper-input {
      @apply --layout-flex;
    }
    </style>
  </custom-style>`;

document.body.appendChild($_documentContainer.content);
</script>
</head>
<body>
  <script type="module">
const $_documentContainer = document.createElement('template');

$_documentContainer.innerHTML = `<header>
    <h1>Query model demo</h1><h1>
  </h1></header>`;

document.body.appendChild($_documentContainer.content);
</script>
  <script type="module">
const $_documentContainer = document.createElement('template');

$_documentContainer.innerHTML = `<dom-bind id="demo">
    <template is="dom-bind">
      <request-model id="model" on-request-indexing-finished="_indexFinished"></request-model>
      <section class="card centered options">
        <h2>Data options</h2>
        <paper-button on-click="genData">Generate data</paper-button>
        <paper-button on-click="deleteData">Destroy data</paper-button>
      </section>
      <section class="card centered options">
        <h2>Database options</h2>
        <paper-dropdown-menu label="Request type">
          <paper-listbox slot="dropdown-content" selected="{{requestType}}">
            <paper-item>History</paper-item>
            <paper-item>Saved</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-checkbox checked="{{restorePayload}}">Restore payload data with request</paper-checkbox>
      </section>

      <section class="centered card" role="main">
        <h2>Request data</h2>
        <div class="search-box">
          <iron-form>
            <form method="post">
              <template is="dom-repeat" items="{{keys}}">
                <div class="form-item">
                  <paper-input label="Request id" value="{{item.id}}"></paper-input>
                  <paper-button on-click="removeKey">Remove</paper-button>
                </div>
              </template>
              <paper-button on-click="addKey">Add another</paper-button>
            </form>
          </iron-form>

          <paper-button on-click="getData">Get data</paper-button>
        </div>
      </section>

      <template is="dom-if" if="[[hasResults]]">
        <section class="centered card" role="main">
          <h2>Search Results ([[results.length]])</h2>
          <template is="dom-repeat" items="[[results]]">
            <p>[[index]]: [[item._id]], [[item.type]]</p>
          </template>
        </section>
      </template>

    </template>
  </dom-bind>`;

document.body.appendChild($_documentContainer.content);
</script>
  <script type="module">
const $_documentContainer = document.createElement('template');
$_documentContainer.innerHTML = `<paper-toast text="Data is indexed" id="indexOk"></paper-toast>`;
document.body.appendChild($_documentContainer.content);
</script>
  <script type="module">
const $_documentContainer = document.createElement('template');
$_documentContainer.innerHTML = `<paper-toast text="Datastore cleared" id="deleteOk"></paper-toast>`;
document.body.appendChild($_documentContainer.content);
</script>
  <script type="module">
const $_documentContainer = document.createElement('template');
$_documentContainer.innerHTML = `<paper-toast text="Datastore indexed" id="indexedOk"></paper-toast>`;
document.body.appendChild($_documentContainer.content);
</script>
  <script type="module">
import '../../../@webcomponents/shadycss/entrypoints/apply-shim.js';
import '../../../@polymer/polymer/lib/elements/custom-style.js';
import '../../../@polymer/polymer/lib/elements/dom-bind.js';
import '../../../@polymer/iron-demo-helpers/demo-pages-shared-styles.js';
import '../../../@polymer/paper-input/paper-input.js';
import '../../../@polymer/paper-button/paper-button.js';
import '../../../@polymer/paper-checkbox/paper-checkbox.js';
import '../../../@polymer/paper-toast/paper-toast.js';
import '../../../@polymer/paper-dropdown-menu/paper-dropdown-menu.js';
import '../../../@polymer/paper-item/paper-item.js';
import '../../../@polymer/paper-listbox/paper-listbox.js';
import '../../../@polymer/neon-animation/web-animations.js';
import '../../../app-pouchdb/pouchdb.js';
import '../../../@polymer/paper-styles/shadow.js';
import '../../../@polymer/iron-form/iron-form.js';
import '../request-model.js';
(function(scope) {
  /* global chance, RequestDb */
  scope.keys = [{'id': ''}];
  scope.requestType = 0;
  scope.hasResults = false;
  scope.addKey = function() {
    scope.push('keys', {'id': ''});
  };

  scope.removeKey = function(e) {
    const index = e.model.get('index');
    scope.splice('keys', index, 1);
  };

  scope.genData = function() {
    const domains = [
      'https://domain.com/',
      'https://api.domain.com/',
      'https://domain.com/domain/',
      'https://mulesoft.com/',
      'https://api.mulesoft.com/',
      'http://other.com/'
    ];
    const history = [];
    const saved = [];
    for (let i = 0; i < 1000; i++) {
      let url = chance.pickone(domains);
      for (let j = 0; j < chance.integer({min: 0, max: 3}); j++) {
        url += chance.word() + '/';
      }
      url = url.substr(0, url.length - 1);
      if (chance.bool()) {
        url += '?a=b&c=d';
      }
      const type = chance.bool() ? 'history' : 'saved';
      const item = {
        _id: chance.guid({version: 5}),
        url,
        type,
        method: 'GET',
        headers: 'x-headers: true'
      };
      if (type === 'history') {
        history[history.length] = item;
      } else {
        item.name = chance.word();
        saved[saved.length] = item;
      }
    }
    performance.mark('inserts-start');
    const model = document.getElementById('model');
    model.updateBulk('history', history);
    model.updateBulk('saved', saved);
  };

  scope._dumpMeasurements = function() {
    const ms = performance.getEntriesByType('measure');
    console.table(ms.map((item) => {
      return {
        name: item.name,
        duration: item.duration
      };
    }));
    performance.clearMeasures();
  };

  scope._indexFinished = function() {
    performance.mark('inserts-end');
    performance.measure('inserts-end', 'inserts-start');
    console.log('Indexing finished');
    scope._dumpMeasurements();
    document.getElementById('indexOk').opened = true;
  };
  scope.deleteData = function() {
    const indexer = new RequestDb();
    return indexer.openSearchStore()
    .then((db) => {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('urls', 'readwrite');
        const store = tx.objectStore('urls');
        const results = [];
        tx.onerror = () => {
          reject(results);
        };
        tx.oncomplete = () => {
          resolve(results);
        };
        store.clear();
      });
    })
    .then(() => {
      document.getElementById('deleteOk').opened = true;
    });
  };

  scope.getData = function() {
    scope.hasResults = false;
    const keys = scope.keys.map((item) => item.id);
    if (!keys) {
      return;
    }
    const detail = {
      id: keys.length === 1 ? keys[0] : keys,
      opts: {}
    };
    if (scope.restorePayload) {
      detail.opts.restorePayload = true;
    }
    switch (scope.requestType) {
      case 0: detail.type = 'history'; break;
      case 1: detail.type = 'saved'; break;
    }
    const e = new CustomEvent('request-object-read', {
      cancelable: true,
      bubbles: true,
      detail
    });
    performance.mark('data-search');
    document.body.dispatchEvent(e);
    e.detail.result
    .then((data) => {
      performance.mark('data-search-end');
      performance.measure('data-search-end', 'data-search');
      scope._dumpMeasurements();
      console.log('Query result', data);
      if (!(data instanceof Array)) {
        data = [data];
      }
      scope.results = data;
      scope.hasResults = true;
    });
  };

  scope.forceIndex = function() {
    const model = document.getElementById('model');
    performance.mark('index-history');
    model.indexData('history')
    .then(() => {
      performance.mark('index-history-end');
      performance.measure('index-history-end', 'index-history');
      performance.mark('index-saved');
      return model.indexData('saved');
    })
    .then(() => {
      performance.mark('index-saved-end');
      performance.measure('index-saved-end', 'index-saved');
      scope._dumpMeasurements();
      document.getElementById('indexedOk').opened = true;
    });
  };
})(document.getElementById('demo'));
</script>
</body>
</html>
