<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>Request index demo</title>
  <script>
  window.Polymer = {
    passiveTouchGestures: true
  };
  </script>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <link rel="import" href="../../shadycss/apply-shim.html">
  <link rel="import" href="../../polymer/lib/elements/custom-style.html">
  <link rel="import" href="../../polymer/lib/elements/dom-bind.html">
  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../paper-input/paper-input.html">
  <link rel="import" href="../../paper-button/paper-button.html">
  <link rel="import" href="../../app-pouchdb/pouchdb.html">
  <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel="import" href="../../paper-listbox/paper-listbox.html">
  <link rel="import" href="../../paper-item/paper-item.html">
  <link rel="import" href="../../neon-animation/web-animations.html">
  <link rel="import" href="../../paper-toast/paper-toast.html">
  <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  <link rel="import" href="../../paper-styles/shadow.html">
  <link rel="import" href="../../iron-list/iron-list.html">
  <link rel="import" href="../../paper-toggle-button/paper-toggle-button.html">
  <link rel="import" href="../url-indexer.html">
  <custom-style>
    <style include="demo-pages-shared-styles">
    :root {
      --arc-font-body1: {
        @apply --paper-font-body1;
      }
    }

    h1 {
      @apply --paper-font-headline;
    }

    h2 {
      @apply --paper-font-title;
    }

    h3 {
      @apply --paper-font-subhead;
    }

    output {
      white-space: pre-wrap;
      @apply --paper-font-code1;
      font-size: 16px;
    }

    .form-row {
      @apply --layout-horizontal;
      @apply --layout-end;
    }

    .form-row > * {
      margin-right: 12px;
    }

    .type-label {
      display: inline-block;
      background-color: #c5c5c5;
      padding: 2px 4px;
      border-radius: 3px;
    }

    li {
      margin: 8px 0;
    }

    .card {
      @apply --shadow-elevation-3dp;
      margin-top: 12px;
      margin-bottom: 12px;
      background-color: #fff;
      padding: 12px;
    }

    .result-list {
      max-height: 300px;
      overflow: auto;
    }

    iron-list {
      height: 213px;
    }

    .request-url {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: pre-wrap;
      color: #888888;
    }

    .iron-li {
      padding: 4px 8px;
      box-sizing: border-box;
    }

    .q {
      @apply --layout-flex;
    }
    </style>
  </custom-style>
</head>
<body>
  <header>
    <h1>URL indexer model<h1>
  </header>
  <dom-bind id="demo">
    <template>
      <url-indexer id="indexer"></url-indexer>
      <div class="vertical-section-container centered options card">
        <h2>Options</h2>

        <div class="form-row">
          <p>Generate</p>
          <paper-input label="Size" value="{{genSize}}" type="number" step="1"></paper-input>
          <paper-dropdown-menu label="Type">
            <paper-listbox slot="dropdown-content" selected="{{genType}}">
              <paper-item>Saved</paper-item>
              <paper-item>History</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <p>requests</p>
          <paper-button on-click="genData">Go</paper-button>
        </div>

        <div class="form-row">
          <p>Index</p>
          <paper-dropdown-menu label="Type">
            <paper-listbox slot="dropdown-content" selected="{{indexType}}">
              <paper-item>Saved</paper-item>
              <paper-item>History</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <p>data</p>
          <paper-button on-click="indexData">Go</paper-button>
        </div>

        <div class="form-row">
          <p>Clear</p>
          <paper-dropdown-menu label="Type">
            <paper-listbox slot="dropdown-content" selected="{{clearType}}">
              <paper-item>Saved</paper-item>
              <paper-item>History</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <p>index</p>
          <paper-button on-click="clearData">Go</paper-button>
        </div>

        <div class="form-row">
          <p>Clear all index data</p>
          <paper-button on-click="deleteData">Go</paper-button>
        </div>
      </div>

      <div class="vertical-section-container centered card" role="main">
        <h2>Search data store</h2>
        <div class="form-row">
          <paper-input class="q" label="Search term" id="q" name="q" value="{{q}}"></paper-input>
          <paper-button on-click="search">Search</paper-button>
        </div>
        <paper-toggle-button checked="{{detailedQuery}}">Detailed search</paper-toggle-button>
      </div>

      <template is="dom-if" if="[[generated]]">
        <div class="centered card result-list">
          <h3>Existing data</h3>
          <p>Found [[generated.length]] requests in [[refreshTime]] ms</p>
          <iron-list items="[[generated]]">
            <template>
              <div class="iron-li">
                <template is="dom-if" if="[[item.isSaved]]">
                  <span class="type-label">Saved</span>
                  <span class="request-name">[[item.name]]</span>
                </template>
                <template is="dom-if" if="[[item.isHistory]]">
                  <span class="type-label">History</span>
                </template>
                <span class="request-url">[[item.url]]</span>
              </div>
            </template>
          </iron-list>
        </div>
      </template>

      <template is="dom-if" if="[[queryResult]]">
        <div class="centered card result-list">
          <h3>Query result</h3>
          <p>Found [[queryResult.length]] results in [[queryTime]] ms</p>
          <ul>
          <template is="dom-repeat" items="[[queryResult]]">
            <li>
              <template is="dom-if" if="[[item.isSaved]]">
                <span class="type-label">Saved</span>
              </template>
              <template is="dom-if" if="[[item.isHistory]]">
                <span class="type-label">History</span>
              </template>
              <span class="request-url">[[item.id]]</span>
            </li>
          </template>
          </ul>
        </div>
      </template>

      <paper-toast text="Data is being generated" id="creating" duration="0"></paper-toast>
      <paper-toast text="Request data ready" id="requestDataReady"></paper-toast>
      <paper-toast text="Reindexing request data" id="reindexing" duration="0"></paper-toast>
      <paper-toast text="Request data index complete" id="reindexReady"></paper-toast>
      <paper-toast text="Index for type cleared" id="typeClearReady"></paper-toast>
      <paper-toast text="Index is now cleared" id="indexClearReady"></paper-toast>
    </template>
  </dom-bind>
  <script>
  (function(scope) {
    /* global DataGenerator */
    scope.q = 'api';
    scope.genSize = 250;
    scope.genType = 0;
    scope.indexType = 0;
    scope.clearType = 0;
    scope.detailedQuery = true;

    scope.load = function() {
      scope.refreshData();
    };

    scope.genData = function() {
      if (scope.genType === 0) {
        scope.genSavedData();
      } else if (scope.genType === 1) {
        scope.genHistoryData();
      }
    };

    scope.genSavedData = function() {
      document.getElementById('creating').opened = true;
      DataGenerator.insertSavedRequestData({
        requestsSize: Number(scope.genSize)
      })
      .then(() => {
        document.getElementById('creating').opened = false;
        document.getElementById('requestDataReady').opened = true;
        scope.refreshData('saved');
      });
    };

    scope.genHistoryData = function() {
      document.getElementById('creating').opened = true;
      DataGenerator.insertHistoryRequestData({
        requestsSize: Number(scope.genSize)
      })
      .then(() => {
        document.getElementById('creating').opened = false;
        document.getElementById('requestDataReady').opened = true;
        scope.refreshData('history');
      });
    };

    scope.refreshData = function(type) {
      let p;
      performance.mark('refresh-start');
      if (type === 'saved') {
        p = DataGenerator.getDatastoreRequestData();
      } else if (type === 'history') {
        p = DataGenerator.getDatastoreHistoryData();
      } else {
        p = DataGenerator.getDatastoreRequestData()
        .then((data) => {
          return DataGenerator.getDatastoreHistoryData()
          .then((other) => {
            return other.concat(data);
          });
        });
      }
      p.then((data) => {
        performance.mark('refresh-end');
        data = data.map((item) => {
          return {
            name: item.name,
            url: item.url,
            isSaved: item.type === 'saved',
            isHistory: item.type !== 'saved'
          };
        });
        scope.generated = scope.generated ? scope.generated.concat(data) : data;
        performance.measure(
          'refresh-time',
          'refresh-start',
          'refresh-end'
        );
        const measures = performance.getEntriesByName('refresh-time');
        const measure = measures[0];
        scope.refreshTime = measure.duration;
        performance.clearMarks();
        performance.clearMeasures();
      });
    };

    scope.indexData = function() {
      let t;
      if (scope.indexType === 0) {
        t = 'saved';
      } else if (scope.indexType === 1) {
        t = 'history';
      } else {
        throw new Error('Unknown type');
      }

      scope._indexData(t);
    };

    scope._indexData = function(type) {
      document.getElementById('reindexing').opened = true;
      const indexer = document.getElementById('indexer');
      performance.mark('indexing-start');
      indexer.reindex(type)
      .then(() => {
        performance.mark('indexing-end');
        document.getElementById('reindexReady').opened = true;
        performance.measure(
          'indexing-time',
          'indexing-start',
          'indexing-end'
        );
        const measures = performance.getEntriesByName('indexing-time');
        const measure = measures[0];
        console.debug('Index built in', measure.duration);
        performance.clearMarks();
        performance.clearMeasures();
      });
    };

    scope.clearData = function() {
      let t;
      if (scope.clearType === 0) {
        t = 'saved';
      } else if (scope.clearType === 1) {
        t = 'history';
      } else {
        throw new Error('Unknown type');
      }
      const indexer = document.getElementById('indexer');
      indexer.deleteIndexedType(t)
      .then(() => {
        document.getElementById('typeClearReady').opened = true;
      });
    };

    scope.search = function() {
      const query = document.getElementById('q').value;
      const indexer = document.getElementById('indexer');
      scope.queryResult = false;
      const opts = {};
      if (scope.detailedQuery === true) {
        opts.detailed = true;
      }
      performance.mark('query-start');
      return indexer.query(query, opts)
      .then((result) => {
        performance.mark('query-end');
        console.debug('Search complete');
        const data = Object.keys(result).map((key) => {
          const type = result[key];
          return {
            isHistory: type === 'history',
            isSaved: type === 'saved',
            id: key
          };
        });
        scope.queryResult = data;
        performance.measure(
          'query-time',
          'query-start',
          'query-end'
        );
        const measures = performance.getEntriesByName('query-time');
        const measure = measures[0];
        scope.queryTime = measure.duration;
        performance.clearMarks();
        performance.clearMeasures();
      });
    };

    scope.deleteData = function() {
      const indexer = document.getElementById('indexer');
      return indexer.clearIndexedData()
      .then(() => {
        document.getElementById('indexClearReady').opened = true;
      });
    };

    window.addEventListener('WebComponentsReady', scope.load);
  })(document.getElementById('demo'));
  </script>
</body>
</html>
