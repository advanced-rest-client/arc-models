<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../../arc-data-generator/arc-data-generator.html">
    <link rel="import" href="../../auth-data-model.html">
  </head>
  <body>
    <test-fixture id="Basic">
      <template>
        <auth-data-model></auth-data-model>
      </template>
    </test-fixture>
    <script>
    /* global DataGenerator */
    const url = 'http://domain.com/auth';
    const method = 'x-ntlm';

    suite('"auth-data-query"', function() {
      suiteSetup(function() {
        const element = fixture('Basic');
        return element.update(url, method, {
          username: 'uname-test',
          password: 'pwd-test',
          domain: 'some'
        });
      });

      suiteTeardown(function() {
        return DataGenerator.destroyAuthDataData();
      });

      test('Cancels the event', () => {
        fixture('Basic');
        const e = new CustomEvent('auth-data-query', {
          bubbles: true,
          cancelable: true,
          detail: {
            url,
            authMethod: method
          }
        });
        document.body.dispatchEvent(e);
        return e.detail.result
        .then(() => {
          assert.isTrue(e.defaultPrevented);
        });
      });

      test('Ignores non-cancellable event', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: false,
          detail: {
            url,
            authMethod: method
          }
        };
        element._queryHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Ignores cancelled event', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          defaultPrevented: true,
          detail: {
            url,
            authMethod: method
          }
        };
        element._queryHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Ignores self dispatched events', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          composedPath: function() {
            return [element];
          },
          detail: {
            url,
            authMethod: method
          }
        };
        element._queryHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Resutls with auth data', () => {
        fixture('Basic');
        const e = new CustomEvent('auth-data-query', {
          bubbles: true,
          cancelable: true,
          detail: {
            url,
            authMethod: method
          }
        });
        document.body.dispatchEvent(e);
        return e.detail.result
        .then((result) => {
          assert.equal(result.username, 'uname-test');
          assert.equal(result.password, 'pwd-test');
          assert.equal(result.domain, 'some');
        });
      });

      test('Handles exceptions', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          composedPath: () => [],
          preventDefault: () => {},
          stopPropagation: () => {},
          detail: {
            url,
            authMethod: method
          }
        };
        element.query = () => {
          return Promise.reject(new Error('test'));
        };
        let called = false;
        element._queryHandler(e);
        return e.detail.result
        .catch((cause) => {
          if (cause.message === 'test') {
            called = true;
          }
        })
        .then(() => {
          assert.isTrue(called);
        });
      });
    });

    suite('"auth-data-changed" event', () => {
      const authData = {test: true};
      suiteTeardown(function() {
        return DataGenerator.destroyAuthDataData();
      });

      test('Ignores non-cancellable event', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: false,
          detail: {
            url,
            authMethod: method,
            authData
          }
        };
        element._updateHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Ignores cancelled event', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          defaultPrevented: true,
          detail: {
            url,
            authMethod: method,
            authData
          }
        };
        element._updateHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Ignores self dispatched events', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          composedPath: function() {
            return [element];
          },
          detail: {
            url,
            authMethod: method,
            authData
          }
        };
        element._updateHandler(e);
        assert.isUndefined(e.detail.result);
      });

      test('Cancels the event', () => {
        fixture('Basic');
        const e = new CustomEvent('auth-data-changed', {
          bubbles: true,
          cancelable: true,
          detail: {
            url,
            authMethod: method,
            authData
          }
        });
        document.body.dispatchEvent(e);
        return e.detail.result
        .then(() => {
          assert.isTrue(e.defaultPrevented);
        });
      });

      test('Handles exceptions', () => {
        const element = fixture('Basic');
        const e = {
          cancelable: true,
          composedPath: () => [],
          preventDefault: () => {},
          stopPropagation: () => {},
          detail: {
            url,
            authMethod: method,
            authData
          }
        };
        element.update = () => {
          return Promise.reject(new Error('test'));
        };
        let called = false;
        element._updateHandler(e);
        return e.detail.result
        .catch((cause) => {
          if (cause.message === 'test') {
            called = true;
          }
        })
        .then(() => {
          assert.isTrue(called);
        });
      });

      test('Calls update function', () => {
        let args;
        const element = fixture('Basic');
        element.update = function() {
          args = arguments;
          return Promise.resolve();
        };
        const e = new CustomEvent('auth-data-changed', {
          bubbles: true,
          cancelable: true,
          detail: {
            url,
            authMethod: method,
            authData
          }
        });
        document.body.dispatchEvent(e);
        return e.detail.result
        .then(() => {
          assert.ok(args);
          assert.equal(args[0], url);
          assert.equal(args[1], method);
          assert.deepEqual(args[2], authData);
        });
      });
    });
    </script>
  </body>
</html>
