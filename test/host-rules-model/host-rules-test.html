<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../../wct-browser-legacy/browser.js"></script>
    <script src="../../../../@polymer/iron-test-helpers/test-helpers.js" type="module"></script>
    <script type="module" src="../../../../arc-data-generator/arc-data-generator.js"></script>
    <script type="module" src="../../../../app-pouchdb/pouchdb.js"></script>
    <script type="module" src="../../host-rules-model.js"></script>
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <host-rules-model></host-rules-model>
      </template>
    </test-fixture>

    <script type="module">
import '../../../../arc-data-generator/arc-data-generator.js';
import '../../../../app-pouchdb/pouchdb.js';
import '../../host-rules-model.js';
/* global DataGenerator */
suite('Static methods', function() {
  suite('update()', function() {
    teardown(function() {
      return DataGenerator.destroyHostRulesData();
    });

    let element;
    let dataObj;
    setup(function() {
      element = fixture('basic');
      dataObj = {
        _id: 'test-id-1',
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      };
    });

    test('Creates a new object in the datastore', function() {
      return element.update(dataObj)
      .then((result) => {
        assert.typeOf(result._rev, 'string', '_rev is set');
        assert.equal(result._id, 'test-id-1', '_id is set');
        assert.equal(result.from, dataObj.from, 'from is set');
      });
    });

    test('Updates created object', function() {
      let originalRev;
      return element.update(dataObj)
      .then((result) => {
        originalRev = result._rev;
        result.comment = 'test-2';
        return element.update(result);
      })
      .then((result) => {
        assert.notEqual(result._rev, originalRev, '_rev is regenerated');
        assert.equal(result._id, 'test-id-1', '_id is the same');
        assert.equal(result.comment, 'test-2', 'comment is set');
        assert.equal(result.from, dataObj.from, 'from is set');
      });
    });

    test('Fires host-rules-changed custom event', function() {
      const spy = sinon.spy();
      element.addEventListener('host-rules-changed', spy);
      return element.update(dataObj)
      .then(() => {
        assert.isTrue(spy.calledOnce);
      });
    });

    test('The host-rules-changed event has properties of newly created object', function() {
      let eventData;
      element.addEventListener('host-rules-changed', function(e) {
        eventData = e.detail;
      });
      return element.update(dataObj)
      .then((result) => {
        assert.isUndefined(eventData.oldRev);
        assert.isUndefined(result.oldRev);
        assert.typeOf(eventData.rule, 'object');
      });
    });

    test('The host-rules-changed event has properties of updated object', function() {
      let eventData;
      let originalRev;
      return element.update(dataObj)
      .then((result) => {
        element.addEventListener('host-rules-changed', function(e) {
          eventData = e.detail;
        });
        originalRev = result._rev;
        result.comment = 'test-2';
        return element.update(result);
      })
      .then(() => {
        assert.equal(eventData.oldRev, originalRev);
        assert.typeOf(eventData.rule, 'object');
        assert.notEqual(eventData.rule._rev, originalRev);
      });
    });
  });

  suite('read()', function() {
    teardown(function() {
      return DataGenerator.destroyHostRulesData();
    });

    let element;
    let dataObj;
    setup(function() {
      element = fixture('basic');
      dataObj = {
        _id: 'test-id-1',
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      };
      return element.update(dataObj);
    });

    test('Reads project object by id only', function() {
      return element.read(dataObj._id)
      .then((result) => {
        assert.equal(result._id, dataObj._id);
      });
    });

    test('Reads a revision', function() {
      let originalRev;
      let updatedRev;
      return element.read(dataObj._id)
      .then((result) => {
        originalRev = result._rev;
        result.comment = 'test-2';
        return element.update(result);
      })
      .then((result) => {
        updatedRev = result._rev;
        return element.read(dataObj._id, originalRev);
      })
      .then((result) => {
        assert.equal(result.comment, dataObj.comment);
        assert.notEqual(originalRev, updatedRev);
      });
    });
  });

  suite('remove()', function() {
    teardown(function() {
      return DataGenerator.destroyHostRulesData();
    });

    let element;
    let dataObj;
    setup(function() {
      element = fixture('basic');
      dataObj = {
        _id: 'test-id-1',
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      };
      return element.update(dataObj)
      .then((result) => dataObj = result);
    });

    test('Removes object from the datastore', function() {
      return element.remove(dataObj._id, dataObj._rev)
      .then(() => {
        return element.read(dataObj._id);
      })
      .then(() => {
        throw new Error('TEST');
      })
      .catch((cause) => {
        assert.equal(cause.status, 404);
      });
    });

    test('Fires host-rules-deleted custom event', function() {
      const spy = sinon.spy();
      element.addEventListener('host-rules-deleted', spy);
      return element.remove(dataObj._id, dataObj._rev)
      .then(() => {
        assert.isTrue(spy.calledOnce);
      });
    });

    test('host-rules-deleted event contains project data', function() {
      let eventData;
      element.addEventListener('host-rules-deleted', function(e) {
        eventData = e.detail;
      });
      return element.remove(dataObj._id, dataObj._rev)
      .then(() => {
        assert.equal(eventData.id, dataObj._id);
        assert.equal(eventData.oldRev, dataObj._rev);
        assert.typeOf(eventData.rev, 'string');
        assert.notEqual(eventData.rev, dataObj._rev);
      });
    });
  });

  suite('list()', function() {
    teardown(function() {
      return DataGenerator.destroyHostRulesData();
    });

    let element;
    let dataObj;
    setup(function() {
      element = fixture('basic');
      dataObj = {
        _id: 'test-id-1',
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      };
      return element.update(dataObj)
      .then((result) => dataObj = result);
    });

    test('Lists host rules', function() {
      return element.list()
      .then((result) => {
        assert.typeOf(result, 'array');
        assert.lengthOf(result, 1);
      });
    });
  });

  suite('updateBulk()', function() {
    teardown(function() {
      return DataGenerator.destroyHostRulesData();
    });

    let element;
    let data;
    setup(function() {
      element = fixture('basic');
      data = [{
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      }, {
        from: 'https://from',
        to: 'http://to',
        enabled: true,
        comment: 'test'
      }];
    });

    test('Inserts data to the store', function() {
      return element.updateBulk(data)
      .then(() => element.list())
      .then((result) => {
        assert.lengthOf(result, 2);
      });
    });

    test('Results with insert resut data', function() {
      return element.updateBulk(data)
      .then((response) => {
        assert.typeOf(response, 'array');
        assert.lengthOf(response, 2);
        assert.isTrue(response[0].ok);
      });
    });
  });
});
</script>

  </body>
</html>
