<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../demo/database-helper.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../arc-models.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <host-rules-model></host-rules-model>
      </template>
    </test-fixture>

    <script>
    /* global DatabaseHelper, fixture, assert, sinon */
    suite('Static methods', function() {

      suite('update()', function() {
        teardown(function() {
          return DatabaseHelper.clearHostRules();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            from: 'https://from',
            to: 'http://to',
            enabled: true,
            comment: 'test'
          };
        });

        test('Creates a new object in the datastore', function() {
          return element.update(dataObj)
          .then((result) => {
            assert.typeOf(result._rev, 'string', '_rev is set');
            assert.equal(result._id, 'test-id-1', '_id is set');
            assert.equal(result.from, dataObj.from, 'from is set');
          });
        });

        test('Updates created object', function() {
          let originalRev;
          return element.update(dataObj)
          .then((result) => {
            originalRev = result._rev;
            result.comment = 'test-2';
            return element.update(result);
          })
          .then((result) => {
            assert.notEqual(result._rev, originalRev, '_rev is regenerated');
            assert.equal(result._id, 'test-id-1', '_id is the same');
            assert.equal(result.comment, 'test-2', 'comment is set');
            assert.equal(result.from, dataObj.from, 'from is set');
          });
        });

        test('Fires host-rules-changed custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('host-rules-changed', spy);
          return element.update(dataObj)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('The host-rules-changed event has properties of newly created object', function() {
          let eventData;
          element.addEventListener('host-rules-changed', function(e) {
            eventData = e.detail;
          });
          return element.update(dataObj)
          .then((result) => {
            assert.isUndefined(eventData.oldRev);
            assert.isUndefined(result.oldRev);
            assert.typeOf(eventData.rule, 'object');
          });
        });

        test('The host-rules-changed event has properties of updated object', function() {
          let eventData;
          let originalRev;
          return element.update(dataObj)
          .then((result) => {
            element.addEventListener('host-rules-changed', function(e) {
              eventData = e.detail;
            });
            originalRev = result._rev;
            result.comment = 'test-2';
            return element.update(result);
          })
          .then(() => {
            assert.equal(eventData.oldRev, originalRev);
            assert.typeOf(eventData.rule, 'object');
            assert.notEqual(eventData.rule._rev, originalRev);
          });
        });
      });

      suite('read()', function() {
        teardown(function() {
          return DatabaseHelper.clearHostRules();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            from: 'https://from',
            to: 'http://to',
            enabled: true,
            comment: 'test'
          };
          return element.update(dataObj);
        });

        test('Reads project object by id only', function() {
          return element.read(dataObj._id)
          .then((result) => {
            assert.equal(result._id, dataObj._id);
          });
        });

        test('Reads a revision', function() {
          let originalRev;
          let updatedRev;
          return element.read(dataObj._id)
          .then((result) => {
            originalRev = result._rev;
            result.comment = 'test-2';
            return element.update(result);
          })
          .then((result) => {
            updatedRev = result._rev;
            return element.read(dataObj._id, originalRev);
          })
          .then((result) => {
            assert.equal(result.comment, dataObj.comment);
            assert.notEqual(originalRev, updatedRev);
          });
        });
      });

      suite('remove()', function() {
        teardown(function() {
          return DatabaseHelper.clearHostRules();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            from: 'https://from',
            to: 'http://to',
            enabled: true,
            comment: 'test'
          };
          return element.update(dataObj)
          .then((result) => dataObj = result);
        });

        test('Removes object from the datastore', function() {
          return element.remove(dataObj._id, dataObj._rev)
          .then(() => {
            return element.read(dataObj._id);
          })
          .then(() => {
            throw new Error('TEST');
          })
          .catch((cause) => {
            assert.equal(cause.status, 404);
          });
        });

        test('Fires host-rules-deleted custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('host-rules-deleted', spy);
          return element.remove(dataObj._id, dataObj._rev)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('host-rules-deleted event contains project data', function() {
          let eventData;
          element.addEventListener('host-rules-deleted', function(e) {
            eventData = e.detail;
          });
          return element.remove(dataObj._id, dataObj._rev)
          .then(() => {
            assert.equal(eventData.id, dataObj._id);
            assert.equal(eventData.oldRev, dataObj._rev);
            assert.typeOf(eventData.rev, 'string');
            assert.notEqual(eventData.rev, dataObj._rev);
          });
        });
      });

      suite('list()', function() {
        teardown(function() {
          return DatabaseHelper.clearHostRules();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            from: 'https://from',
            to: 'http://to',
            enabled: true,
            comment: 'test'
          };
          return element.update(dataObj)
          .then((result) => dataObj = result);
        });

        test('Lists host rules', function() {
          return element.list()
          .then((result) => {
            assert.typeOf(result, 'array');
            assert.lengthOf(result, 1);
          });
        });
      });
    });
    </script>

  </body>
</html>
