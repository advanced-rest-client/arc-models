<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../../../iron-test-helpers/test-helpers.js"></script>
    <link rel="import" href="../../../arc-data-generator/arc-data-generator.html">
    <link rel="import" href="../../arc-models.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <project-model></project-model>
      </template>
    </test-fixture>
    <script>
    /* global DataGenerator */
    suite('Static methods', function() {
      suite('updateProject()', function() {
        teardown(function() {
          return DataGenerator.clearLegacyProjects();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            name: 'test-1',
            order: 1
          };
        });

        test('Creates a new object in the datastore', function() {
          return element.updateProject(dataObj)
          .then((result) => {
            assert.typeOf(result._rev, 'string', '_rev is set');
            assert.equal(result._id, 'test-id-1', '_id is set');
            assert.equal(result.name, 'test-1', 'Name is set');
            assert.equal(result.order, 1, 'order is set');
          });
        });

        test('Updates created object', function() {
          let originalRev;
          return element.updateProject(dataObj)
          .then((result) => {
            originalRev = result._rev;
            result.name = 'test-2';
            return element.updateProject(result);
          })
          .then((result) => {
            assert.notEqual(result._rev, originalRev, '_rev is regenerated');
            assert.equal(result._id, 'test-id-1', '_id is the same');
            assert.equal(result.name, 'test-2', 'Name is set');
            assert.equal(result.order, 1, 'order is set');
          });
        });

        test('Fires project-object-changed custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('project-object-changed', spy);
          return element.updateProject(dataObj)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('The project-object-changed event has new properties ', function() {
          let eventData;
          element.addEventListener('project-object-changed', function(e) {
            eventData = e.detail;
          });
          return element.updateProject(dataObj)
          .then((result) => {
            assert.isUndefined(eventData.oldRev);
            assert.isUndefined(result.oldRev);
            assert.typeOf(eventData.project, 'object');
          });
        });

        test('The project-object-changed event has properties of updated object',
        function() {
          let eventData;
          let originalRev;
          return element.updateProject(dataObj)
          .then((result) => {
            element.addEventListener('project-object-changed', function(e) {
              eventData = e.detail;
            });
            originalRev = result._rev;
            result.name = 'test-2';
            return element.updateProject(result);
          })
          .then(() => {
            assert.equal(eventData.oldRev, originalRev);
            assert.typeOf(eventData.project, 'object');
            assert.notEqual(eventData.project._rev, originalRev);
          });
        });
      });

      suite('read()', function() {
        teardown(function() {
          return DataGenerator.clearLegacyProjects();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            name: 'test-1',
            order: 1
          };
          return element.updateProject(dataObj);
        });

        test('Reads project object by id only', function() {
          return element.readProject(dataObj._id)
          .then((result) => {
            assert.equal(result._id, dataObj._id);
          });
        });

        test('Reads a revision', function() {
          let originalRev;
          let updatedRev;
          return element.readProject(dataObj._id)
          .then((result) => {
            originalRev = result._rev;
            result.name = 'test-2';
            return element.updateProject(result);
          })
          .then((result) => {
            updatedRev = result._rev;
            return element.readProject(dataObj._id, originalRev);
          })
          .then((result) => {
            assert.equal(result.name, dataObj.name);
            assert.notEqual(originalRev, updatedRev);
          });
        });
      });

      suite('remove()', function() {
        teardown(function() {
          return DataGenerator.clearLegacyProjects();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            name: 'test-1',
            order: 1
          };
          return element.updateProject(dataObj)
          .then((result) => dataObj = result);
        });

        test('Removes object from the datastore', function() {
          return element.removeProject(dataObj._id, dataObj._rev)
          .then(() => {
            return element.readProject(dataObj._id);
          })
          .then(() => {
            throw new Error('TEST');
          })
          .catch((cause) => {
            assert.equal(cause.status, 404);
          });
        });

        test('Fires project-object-deleted custom event', function() {
          const spy = sinon.spy();
          element.addEventListener('project-object-deleted', spy);
          return element.removeProject(dataObj._id, dataObj._rev)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
        });

        test('project-object-deleted event contains project data', function() {
          let eventData;
          element.addEventListener('project-object-deleted', function(e) {
            eventData = e.detail;
          });
          return element.removeProject(dataObj._id, dataObj._rev)
          .then(() => {
            assert.equal(eventData.id, dataObj._id);
            assert.equal(eventData.oldRev, dataObj._rev);
            assert.typeOf(eventData.rev, 'string');
            assert.notEqual(eventData.rev, dataObj._rev);
          });
        });
      });

      suite('list()', function() {
        teardown(function() {
          return DataGenerator.clearLegacyProjects();
        });

        let element;
        let dataObj;
        setup(function() {
          element = fixture('basic');
          dataObj = {
            _id: 'test-id-1',
            name: 'test-1',
            order: 1
          };
          return element.updateProject(dataObj)
          .then((result) => dataObj = result);
        });

        test('Lists saved projects', function() {
          return element.listProjects()
          .then((result) => {
            assert.typeOf(result, 'array');
            assert.lengthOf(result, 1);
          });
        });
      });

      suite('_normalizeProjects()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Returns an array', () => {
          const result = element._normalizeProjects([]);
          assert.typeOf(result, 'array');
        });

        test('Removes empty items', () => {
          const result = element._normalizeProjects([undefined, {
            name: 'test'
          }]);
          assert.lengthOf(result, 1);
        });

        test('Adds missing "order" property', () => {
          const result = element._normalizeProjects([{
            name: 'test'
          }]);
          assert.equal(result[0].order, 0);
        });

        test('Adds missing "requests" property', () => {
          const result = element._normalizeProjects([{
            name: 'test'
          }]);
          assert.deepEqual(result[0].requests, []);
        });

        test('Adds missing "created" property', () => {
          const result = element._normalizeProjects([{
            name: 'test'
          }]);
          assert.typeOf(result[0].created, 'number');
        });

        test('Adds "updated" property', () => {
          const result = element._normalizeProjects([{
            name: 'test'
          }]);
          assert.typeOf(result[0].updated, 'number');
        });

        test('Respects existing "requests" property', () => {
          const result = element._normalizeProjects([{
            name: 'test',
            requests: ['test']
          }]);
          assert.deepEqual(result[0].requests, ['test']);
        });

        test('Respects existing "order" property', () => {
          const result = element._normalizeProjects([{
            name: 'test',
            order: 10
          }]);
          assert.equal(result[0].order, 10);
        });

        test('Respects existing "name" property', () => {
          const result = element._normalizeProjects([{
            name: 'test-name'
          }]);
          assert.equal(result[0].name, 'test-name');
        });
      });

      suite('updateBulk()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
        });

        teardown(function() {
          return DataGenerator.clearLegacyProjects();
        });

        test('Returns a promise', () => {
          const projects = [DataGenerator.createProjectObject()];
          const result = element.updateBulk(projects);
          assert.typeOf(result.then, 'function');
          return result;
        });

        test('Resolved promise contains created object', () => {
          const projects = [DataGenerator.createProjectObject()];
          return element.updateBulk(projects)
          .then((result) => {
            assert.typeOf(result, 'array');
            assert.lengthOf(result, 1);
          });
        });

        test('Created object contains _id and _review', () => {
          const projects = [DataGenerator.createProjectObject()];
          return element.updateBulk(projects)
          .then((result) => {
            const item = result[0];
            assert.typeOf(item._id, 'string');
            assert.typeOf(item._rev, 'string');
          });
        });

        test('Created object contains default (and missing) properties', () => {
          const r = DataGenerator.createProjectObject();
          delete r.created;
          delete r.updated;
          delete r.requests;
          return element.updateBulk([r])
          .then((result) => {
            const item = result[0];
            assert.typeOf(item.created, 'number');
            assert.typeOf(item.updated, 'number');
            assert.typeOf(item.requests, 'array');
          });
        });
      });

      suite.only('_processUpdateBulkResponse()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Dispatches "project-object-changed" custom event', () => {
          let eventData;
          element.addEventListener('project-object-changed', function f(e) {
            element.removeEventListener('project-object-changed', f);
            eventData = e.detail;
          });
          const project = DataGenerator.createProjectObject();
          project._rev = 'old-rev';
          element._processUpdateBulkResponse([project], [{
            rev: 'new-rev'
          }]);
          assert.typeOf(eventData, 'object', 'Event was fired');
          assert.typeOf(eventData.project, 'object', 'Detail has "project"');
          assert.equal(eventData.oldRev, 'old-rev', 'Detail has "oldRev"');
          assert.equal(eventData.project._rev, 'new-rev', '_rev is updated');
        });

        test('Returns array of projects', () => {
          const projects = [DataGenerator.createProjectObject()];
          const result = element._processUpdateBulkResponse(projects, [{
            rev: 'new-rev'
          }]);
          assert.typeOf(result, 'array');
          assert.lengthOf(result, 1);
        });

        test('Sets "error" on errored project', () => {
          const projects = [DataGenerator.createProjectObject()];
          const result = element._processUpdateBulkResponse(projects, [{
            error: true
          }]);
          const item = result[0];
          assert.isTrue(item.error);
        });
      });
    });
    </script>
  </body>
</html>
