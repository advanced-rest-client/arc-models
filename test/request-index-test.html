<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
  </head>
  <body>
    <script>
    /* global indexedDB */
    suite('Request indexer worker tests', function() {
      const INDEX_STORE_NAME = 'request-index';
      const INDEX_STORE_VERSION = 1;
      /**
       * Reads all URL indexes datastore
       * @return {Promise}
       */
      function readAllIndexes() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(INDEX_STORE_NAME, INDEX_STORE_VERSION);
          request.onsuccess = (e) => {
            const results = [];
            const db = e.target.result;
            const tx = db.transaction('urls', 'readonly');
            tx.onerror = () => {
              reject(new Error('Get all tx error'));
            };
            tx.oncomplete = () => {
              resolve(results);
            };
            const store = tx.objectStore('urls');
            const request = store.openCursor();
            request.onsuccess = function(e) {
              const cursor = e.target.result;
              if (cursor) {
                results[results.length] = cursor.value;
                cursor.continue();
              }
            };
          };
          request.onerror = function() {
            reject(new Error('Unable to open the store'));
          };
        });
      }
      /**
       * Finds an indexed item in the list of stored items.
       * @param {String} url The url to search for
       * @param {Array} indexed List of indexed items
       * @return {Object}
       */
      function getIndexItemByUrl(url, indexed) {
        return indexed.find((item) =>
          item.url.toLowerCase() === url.toLowerCase());
      }
      /**
       * Removes all indexes from the index data store.
       * @return {Promise}
       */
      function clearData() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(INDEX_STORE_NAME, INDEX_STORE_VERSION);
          request.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction('urls', 'readwrite');
            const store = tx.objectStore('urls');
            tx.onerror = () => {
              reject(new Error('Unable to clear the store'));
            };
            tx.oncomplete = () => {
              resolve();
            };
            store.clear();
          };
          request.onerror = function() {
            reject(new Error('Unable to open the store'));
          };
        });
      }

      suite('Basic indexing', function() {
        const FULL_URL = 'https://domain.com/api?a=b&c=d';
        const REQUEST_ID = 'test-id';
        const REQUEST_TYPE = 'saved';
        let worker;
        teardown(() => {
          if (worker) {
            worker.terminate();
            worker = null;
          }
        });

        suiteTeardown(function() {
          if (worker) {
            worker.terminate();
            worker = null;
          }
          return clearData();
        });

        test('Indexes single request', (done) => {
          worker = new Worker('../workers/request-indexer.js');
          worker.addEventListener('message', function(e) {
            assert.equal(e.data.task, 'task-finished');
            assert.equal(e.data.name, 'index-requests');
            done();
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'index-requests',
            requests: [{
              url: FULL_URL,
              id: REQUEST_ID,
              type: REQUEST_TYPE
            }]
          });
        });
        /**
         * Tests indexed item structure
         * @param {String} url
         * @param {String} name
         * @param {Array} indexed
         */
        function testIndexStructure(url, name, indexed) {
          const data = getIndexItemByUrl(url, indexed);
          assert.ok(data, name + ' URL exists');
          assert.equal(data.id.indexOf(url + '::saved::'), 0,
            name + ' url id is set');
          assert.equal(data.type, REQUEST_TYPE, name + ' type is stored');
          assert.equal(data.requestId, REQUEST_ID, name + ' request id is set');
        }

        test('Creates all entries for single request', () => {
          return readAllIndexes()
          .then((data) => {
            assert.lengthOf(data, 8, 'Has 8 stored elements');

            testIndexStructure(FULL_URL, 'Full url', data);
            testIndexStructure('domain.com/api?a=b&c=d', 'Authority', data);
            testIndexStructure('/api?a=b&c=d', 'Path', data);
            testIndexStructure('a=b&c=d', 'Search', data);
            testIndexStructure('a=b', 'Param #1 string', data);
            testIndexStructure('c=d', 'Param #2 string', data);
            testIndexStructure('b', 'Param #1 value', data);
            testIndexStructure('d', 'Param #2 value', data);
          });
        });

        test('Re-Indexes existing request', (done) => {
          worker = new Worker('../workers/request-indexer.js');
          worker.addEventListener('message', function(e) {
            assert.equal(e.data.task, 'task-finished');
            assert.equal(e.data.name, 'index-requests');

            readAllIndexes()
            .then((data) => {
              assert.lengthOf(data, 8, 'Has 8 stored elements');
              done();
            });
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'index-requests',
            requests: [{
              url: FULL_URL,
              id: REQUEST_ID,
              type: REQUEST_TYPE
            }]
          });
        });

        test('Creates new index for different request ID', (done) => {
          const OTHER_ID = 'abc';
          worker = new Worker('../workers/request-indexer.js');
          worker.addEventListener('message', function(e) {
            assert.equal(e.data.task, 'task-finished');
            assert.equal(e.data.name, 'index-requests');

            readAllIndexes()
            .then((data) => {
              assert.lengthOf(data, 16, 'Has 16 stored elements');
              done();
            });
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'index-requests',
            requests: [{
              url: FULL_URL,
              id: OTHER_ID,
              type: REQUEST_TYPE
            }]
          });
        });

        test('Removes redundant parts of the index', function(done) {
          const FULL_URL = 'https://domain.com/api?a=b';
          worker = new Worker('../workers/request-indexer.js');
          worker.addEventListener('message', function(e) {
            assert.equal(e.data.task, 'task-finished');
            assert.equal(e.data.name, 'index-requests');

            readAllIndexes()
            .then((data) => {
              assert.lengthOf(data, 14, 'Has 14 stored elements');
              done();
            });
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'index-requests',
            requests: [{
              url: FULL_URL,
              id: REQUEST_ID,
              type: REQUEST_TYPE
            }]
          });
        });
      });

      suite('Deletes indexed data', function() {
        const FULL_URL = 'https://domain.com/api?a=b&c=d';
        const REQUEST_ID = 'test-id';
        const REQUEST_ID_2 = 'test-id-2';
        const REQUEST_TYPE = 'saved';
        let worker;
        setup((done) => {
          worker = new Worker('../workers/request-indexer.js');
          worker.addEventListener('message', function f(e) {
            if (e.data.task === 'task-finished') {
              worker.removeEventListener('message', f);
              done();
            }
            if (e.data.task === 'task-error') {
              worker.removeEventListener('message', f);
              done(new Error(e.data.message));
            }
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'index-requests',
            requests: [{
              url: FULL_URL,
              id: REQUEST_ID,
              type: REQUEST_TYPE
            }, {
              url: FULL_URL,
              id: REQUEST_ID_2,
              type: REQUEST_TYPE
            }]
          });
        });

        teardown(() => {
          if (worker) {
            worker.terminate();
            worker = null;
          }
          return clearData();
        });

        test('Deletes index of a single request', (done) => {
          worker.addEventListener('message', function(e) {
            if (e.data.task === 'task-finished') {
              readAllIndexes()
              .then((data) => {
                assert.lengthOf(data, 8);
                done();
              });
            }
            if (e.data.task === 'task-error') {
              done(new Error(e.data.message));
            }
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'delete-index',
            ids: [REQUEST_ID]
          });
        });

        test('Deletes both indexes', (done) => {
          worker.addEventListener('message', function(e) {
            if (e.data.task === 'task-finished') {
              readAllIndexes()
              .then((data) => {
                assert.lengthOf(data, 0);
                done();
              });
            }
            if (e.data.task === 'task-error') {
              done(new Error(e.data.message));
            }
          });
          worker.addEventListener('error', function() {
            done(new Error('Worker error'));
          });
          worker.postMessage({
            task: 'delete-index',
            ids: [REQUEST_ID, REQUEST_ID_2]
          });
        });
      });
    });
    </script>
  </body>
</html>
