<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <script src="../../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../../chance/chance.js"></script>
  <script src="../../demo/database-helper.js"></script>
  <link rel="import" href="../../../app-pouchdb/pouchdb.html">
  <link rel="import" href="../../arc-models.html">
</head>

<body>
  <test-fixture id="basic">
    <template>
      <request-model no-indexing></request-model>
    </template>
  </test-fixture>
  <script>
  /* global DatabaseHelper, sinon */
  suite('request-model test', function() {
    const databaseType = 'saved-requests';

    suite('update()', function() {
      teardown(function() {
        return DatabaseHelper.clearRequests();
      });

      let element;
      let dataObj;
      setup(function() {
        element = fixture('basic');
        dataObj = {
          name: 'test-1',
          url: 'http://domain.com',
          method: 'GET',
          legacyProject: undefined
        };
      });

      test('Creates a new object in the datastore', function() {
        return element.update(databaseType, dataObj)
          .then((result) => {
            assert.typeOf(result._rev, 'string', '_rev is set');
            assert.typeOf(result._id, 'string', '_id is set');
            assert.equal(result.url, dataObj.url, 'URL is set');
            assert.equal(result.name, dataObj.name, 'name is set');
            assert.equal(result.method, dataObj.method, 'method is set');
          });
      });

      test('Updates created object', function() {
        let originalRev;
        return element.update(databaseType, dataObj)
          .then((result) => {
            originalRev = result._rev;
            result.headers = 'x-test';
            return element.update(databaseType, result);
          })
          .then((result) => {
            assert.notEqual(result._rev, originalRev, '_rev is regenerated');
            assert.equal(result.headers, 'x-test', 'Change is recorded');
          });
      });

      test('Fires request-object-changed custom event', function() {
        const spy = sinon.spy();
        element.addEventListener('request-object-changed', spy);
        return element.update(databaseType, dataObj)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
      });

      test('The request-object-changed event has properties of newly created object', function() {
        let eventData;
        element.addEventListener('request-object-changed', function(e) {
          eventData = e.detail;
        });
        return element.update(databaseType, dataObj)
          .then((result) => {
            assert.isUndefined(eventData.oldRev);
            assert.isUndefined(result.oldRev);
            assert.typeOf(eventData.request, 'object');
          });
      });

      test('The request-object-changed event has properties of updated object', function() {
        let eventData;
        let originalRev;
        return element.update(databaseType, dataObj)
          .then((result) => {
            element.addEventListener('request-object-changed', function(e) {
              eventData = e.detail;
            });
            originalRev = result._rev;
            result.name = 'test-2';
            return element.update(databaseType, result);
          })
          .then(() => {
            assert.equal(eventData.oldRev, originalRev);
            assert.typeOf(eventData.request, 'object');
            assert.notEqual(eventData.request._rev, originalRev);
            assert.equal(eventData.type, databaseType);
          });
      });
    });

    suite('updateBulk()', function() {
      teardown(function() {
        return DatabaseHelper.clearRequests();
      });

      let element;
      let dataObj;
      setup(function() {
        element = fixture('basic');
        dataObj = [{
          name: 'test-1',
          url: 'http://domain.com',
          method: 'GET',
          legacyProject: undefined
        }, {
          name: 'test-2',
          url: 'http://domain.com',
          method: 'POST',
          legacyProject: 'abc'
        }];
      });

      test('Creates objects in bulk', function() {
        return element.updateBulk(databaseType, dataObj)
          .then((result) => {
            assert.typeOf(result, 'array', 'Response is an array');
            assert.isTrue(result[0].ok, 'Item #1 is inserted');
            assert.isTrue(result[1].ok, 'Item #2 is inserted');
            assert.typeOf(result[0].rev, 'string', '_rev is set');
            assert.typeOf(result[0].id, 'string', '_id is set');
          });
      });

      test('Updates created object', function() {
        const originalRevs = [];
        return element.updateBulk(databaseType, dataObj)
          .then((result) => {
            for (let i = 0; i < result.length; i++) {
              originalRevs.push(result[i].rev);
              dataObj[i]._rev = result[i].rev;
              dataObj[i]._id = result[i].id;
            }
            dataObj[0].headers = 'x-test';
            return element.updateBulk(databaseType, dataObj);
          })
          .then((result) => {
            assert.notEqual(result[0].rev, originalRevs[0], '_rev is regenerated');
          });
      });

      test('Fires request-object-changed custom event', function() {
        const spy = sinon.spy();
        element.addEventListener('request-object-changed', spy);
        return element.updateBulk(databaseType, dataObj)
          .then(() => {
            assert.equal(spy.callCount, 2);
          });
      });

      test('The request-object-changed event has properties of newly created object', function() {
        let eventData;
        element.addEventListener('request-object-changed', function clb(e) {
          element.removeEventListener('request-object-changed', clb);
          eventData = e.detail;
        });
        return element.updateBulk(databaseType, dataObj)
          .then((result) => {
            assert.isUndefined(eventData.oldRev);
            assert.isUndefined(result.oldRev);
            assert.typeOf(eventData.request, 'object');
          });
      });

      test('The request-object-changed event has properties of updated object', function() {
        let eventData;
        let originalRev;
        return element.updateBulk(databaseType, dataObj)
          .then((result) => {
            element.addEventListener('request-object-changed', function clb(e) {
              element.removeEventListener('request-object-changed', clb);
              eventData = e.detail;
            });
            originalRev = result[0].rev;
            for (let i = 0; i < result.length; i++) {
              dataObj[i]._rev = result[i].rev;
              dataObj[i]._id = result[i].id;
            }
            dataObj[0].name = 'test-2';
            return element.updateBulk(databaseType, dataObj);
          })
          .then(() => {
            assert.equal(eventData.oldRev, originalRev, 'oldRev is set');
            assert.typeOf(eventData.request, 'object', 'request is an object');
            assert.notEqual(eventData.request._rev, originalRev, 'request._rev is updates');
            assert.equal(eventData.type, databaseType, 'Database type is set');
          });
      });
    });

    suite('read()', function() {
      teardown(function() {
        return DatabaseHelper.clearRequests();
      });

      let element;
      let dataObj;
      setup(function() {
        element = fixture('basic');
        dataObj = {
          name: 'test-1',
          url: 'http://domain.com',
          method: 'GET'
        };
        return element.update(databaseType, dataObj)
          .then((result) => dataObj = result);
      });

      test('Reads request object by id only', function() {
        return element.read(databaseType, dataObj._id)
          .then((result) => {
            assert.equal(result._id, dataObj._id);
          });
      });

      test('Reads a revision', function() {
        let originalRev;
        let updatedRev;
        return element.read(databaseType, dataObj._id)
          .then((result) => {
            originalRev = result._rev;
            result.name = 'test-2';
            return element.update(databaseType, result);
          })
          .then((result) => {
            updatedRev = result._rev;
            return element.read(databaseType, dataObj._id, originalRev);
          })
          .then((result) => {
            assert.equal(result.name, dataObj.name);
            assert.notEqual(originalRev, updatedRev);
          });
      });
    });

    suite('remove()', function() {
      teardown(function() {
        return DatabaseHelper.clearRequests();
      });

      let element;
      let dataObj;
      setup(function() {
        element = fixture('basic');
        dataObj = {
          name: 'test-1',
          url: 'http://domain.com',
          method: 'GET'
        };
        return element.update(databaseType, dataObj)
          .then((result) => dataObj = result);
      });

      test('Removes object from the datastore', function() {
        return element.remove(databaseType, dataObj._id, dataObj._rev)
          .then(() => {
            return element.read(databaseType, dataObj._id);
          })
          .then(() => {
            throw new Error('TEST');
          })
          .catch((cause) => {
            assert.equal(cause.status, 404);
          });
      });

      test('Fires request-object-deleted custom event', function() {
        let spy = sinon.spy();
        element.addEventListener('request-object-deleted', spy);
        return element.remove(databaseType, dataObj._id, dataObj._rev)
          .then(() => {
            assert.isTrue(spy.calledOnce);
          });
      });

      test('request-object-deleted event contains request data', function() {
        let eventData;
        element.addEventListener('request-object-deleted', function(e) {
          eventData = e.detail;
        });
        return element.remove(databaseType, dataObj._id, dataObj._rev)
          .then(() => {
            assert.equal(eventData.id, dataObj._id);
            assert.equal(eventData.oldRev, dataObj._rev);
            assert.typeOf(eventData.rev, 'string');
            assert.notEqual(eventData.rev, dataObj._rev);
            assert.equal(eventData.type, databaseType);
          });
      });
    });

    suite('list()', () => {
      suiteSetup(() => {
        return DatabaseHelper.insertHistoryRequestData({
          requestsSize: 150
        });
      });

      suiteTeardown(function() {
        return DatabaseHelper.clearHistory();
      });

      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Returnes all results without limit options', () => {
        return element.list('history', {})
        .then((result) => {
          assert.typeOf(result, 'object');
          assert.typeOf(result.rows, 'array');
          assert.lengthOf(result.rows, 150);
        });
      });

      test('Limits number of results when set', () => {
        return element.list('history', {
          limit: 50
        })
        .then((result) => {
          assert.typeOf(result, 'object');
          assert.typeOf(result.rows, 'array');
          assert.lengthOf(result.rows, 50);
        });
      });

      test('Respects pagination', () => {
        let firstKey;
        return element.list('history', {
          limit: 50
        })
        .then((result) => {
          firstKey = result.rows[0].key;
          return element.list('history', {
            limit: 50,
            startkey: result.rows[result.rows.length - 1].key,
            skip: 1
          });
        })
        .then((result) => {
          assert.typeOf(result, 'object');
          assert.typeOf(result.rows, 'array');
          assert.lengthOf(result.rows, 50);
          assert.notEqual(firstKey, result.rows[0].key);
        });
      });
    });
  });
  </script>
</body>

</html>
