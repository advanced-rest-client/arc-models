<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../wct-browser-legacy/browser.js"></script>
    <script src="../../../@polymer/iron-test-helpers/test-helpers.js" type="module"></script>
    <script src="./database-helper.js"></script>
    <script type="module" src="../arc-models.js"></script>
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <rest-api-model></rest-api-model>
      </template>
    </test-fixture>

    <script type="module">
import '../arc-models.js';
/* global DatabaseHelper, fixture, assert, sinon */

const RAML = {
  title: 'Test-Raml Title',
  version: 'Test-Raml Version',
  baseUri: 'https://Test-base-uri',
  description: 'test-description'
};

function indexDb() {
  return new PouchDB('rest-api-index');
}
function dataDb() {
  return new PouchDB('rest-api-data');
}

suite('Basic API', function() {

  suite('_prepareStoreObject()', function() {
    var element;
    setup(function() {
      element = fixture('basic');
    });

    test('Computes a datastore object', function() {
      var result = element._prepareStoreObject(RAML);
      assert.typeOf(result, 'object');
    });

    test('Datastore object contains RAML data', function() {
      var result = element._prepareStoreObject(RAML);
      assert.deepEqual(result.raml, RAML);
    });

    test('Datastore object contains created property', function() {
      var result = element._prepareStoreObject(RAML);
      assert.typeOf(result.created, 'number');
    });

    test('Datastore object contains _id property', function() {
      var result = element._prepareStoreObject(RAML);
      assert.typeOf(result._id, 'string');
    });

    test('_id property is valid', function() {
      var result = element._prepareStoreObject(RAML);
      assert.isTrue(result._id.indexOf('undefined') === -1, 'Does not contain undefined');
      var parts = result._id.split('/');
      assert.lengthOf(parts, 3, 'ID contains 3 parts');
      assert.equal(parts[0], 'test-raml%20title', 'Title is normalized');
      assert.equal(parts[1], 'test-raml%20version', 'Version is normalized');
      assert.equal(parts[2], 'https%3A%2F%2Ftest-base-uri', 'Base URI is normalized');
    });
  });

  suite('_prepareIndexObject()', function() {
    var element;
    var storeObject;
    setup(function() {
      element = fixture('basic');
      storeObject = element._prepareStoreObject(RAML);
    });

    test('Computes a datastore object', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.typeOf(result, 'object');
    });

    test('Has the same ID', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result._id, storeObject._id);
    });

    test('Has title as in RAML', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result.title, storeObject.raml.title);
    });
    test('Has version as in RAML', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result.version, storeObject.raml.version);
    });
    test('Has baseUri as in RAML', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result.baseUri, storeObject.raml.baseUri);
    });
    test('Has description as in RAML', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result.description, storeObject.raml.description);
    });

    test('Default order is 0', function() {
      var result = element._prepareIndexObject(storeObject);
      assert.equal(result.order, 0);
    });
  });

  suite('create()', function() {

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi();
    });

    var element;
    setup(function() {
      element = fixture('basic');
    });

    test('Creates new object', function() {
      return element.create(RAML)
      .then(result => {
        assert.typeOf(result._rev, 'string');
      });
    });

    test('Index datastore contains one object', function() {
      return indexDb().allDocs({
        // jscs:disable
        include_docs: true
        // jscs:enable
      }).then(result => {
        assert.lengthOf(result.rows, 1);
      });
    });

    test('Data datastore contains one object', function() {
      return dataDb().allDocs().then(result => {
        assert.lengthOf(result.rows, 1);
      });
    });

    test('Creates new object with order property', function() {
      var data = Object.assign({}, RAML);
      data.title = 'test-2';
      const order = 4;
      return element.create(data, order)
      .then(result => {
        assert.strictEqual(result.order, order);
      });
    });
  });

  suite('read()', function() {
    var element;
    var created;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => created = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Reads index data', function() {
      return element.readIndex(created._id)
      .then(doc => {
        assert.deepEqual(doc, created);
      });
    });

    test('Reads raml data', function() {
      return element.readData(created._id)
      .then(doc => {
        assert.ok(doc.raml);
      });
    });
  });

  suite('remove()', function() {
    var element;
    var created;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi();
    });

    setup(function() {
      element = fixture('basic');
      return element.create(RAML)
      .then(doc => created = doc);
    });

    test('Removes the object', function() {
      return element.remove(created._id)
      .then(() => {
        return indexDb().allDocs({
          // jscs:disable
          include_docs: true
          // jscs:enable
        });
      })
      .then(result => {
        assert.lengthOf(result.rows, 0, 'Index items is 0');
        return dataDb().allDocs({
          // jscs:disable
          include_docs: true
          // jscs:enable
        });
      })
      .then(result => {
        assert.lengthOf(result.rows, 0, 'Data items is 0');
      });
    });

    test('Fires rest-api-deleted event', function() {
      var eventData;
      element.addEventListener('rest-api-deleted', function clb(e) {
        element.removeEventListener('rest-api-deleted', clb);
        eventData = e.detail;
      });
      return element.remove(created._id)
      .then(() => {
        assert.typeOf(eventData, 'object', 'Event was fired');
        assert.equal(eventData.id, created._id, 'Event detail contains id');
      });
    });
  });

  suite('updateData()', function() {
    var element;
    var createdIndex;
    var createdData;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => createdIndex = doc)
        .then(() => dataDb().get(createdIndex._id))
        .then(doc => createdData = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Updates data object', function() {
      createdData.created = 1;
      var oldRev = createdData._rev;
      return element.updateData(createdData)
      .then(result => {
        createdData = result;
        assert.notEqual(result._rev, oldRev);
      });
    });

    test('Dispatches rest-api-data-updated custom event', function() {
      createdData.created = 2;
      var oldRev = createdData._rev;
      var eventData;
      element.addEventListener('rest-api-data-updated', function clb(e) {
        element.removeEventListener('rest-api-data-updated', clb);
        eventData = e.detail;
      });

      return element.updateData(createdData)
      .then(result => {
        createdData = result;
        assert.typeOf(eventData, 'object', 'Event was fired');
        assert.deepEqual(eventData.doc, createdData, 'Event detail contains the doc');
        assert.equal(eventData.oldRev, oldRev, 'Event detail contains oldRev');
      });
    });
    test('rest-api-data-updated custom event is not cancelable', function(done) {
      element.addEventListener('rest-api-data-updated', function clb(e) {
        element.removeEventListener('rest-api-data-updated', clb);
        assert.isFalse(e.cancelable);
        done();
      });
      element.updateData(createdData);
    });
  });

  suite('updateIndex()', function() {
    var element;
    var createdIndex;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => createdIndex = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Updates index object', function() {
      createdIndex.title = 'test-1';
      var oldRev = createdIndex._rev;
      return element.updateIndex(createdIndex)
      .then(result => {
        createdIndex = result;
        assert.notEqual(result._rev, oldRev);
      });
    });

    test('Dispatches rest-api-index-updated custom event', function() {
      createdIndex.title = 'test-2';
      var oldRev = createdIndex._rev;
      var eventData;
      element.addEventListener('rest-api-index-updated', function clb(e) {
        element.removeEventListener('rest-api-index-updated', clb);
        eventData = e.detail;
      });

      return element.updateIndex(createdIndex)
      .then(result => {
        createdIndex = result;
        assert.typeOf(eventData, 'object', 'Event was fired');
        assert.deepEqual(eventData.doc, createdIndex, 'Event detail contains the doc');
        assert.equal(eventData.oldRev, oldRev, 'Event detail contains oldRev');
        assert.equal(eventData.doc.title, 'test-2', 'Doc contains newest data');
      });
    });
    test('rest-api-index-updated custom event is not cancelable', function(done) {
      element.addEventListener('rest-api-index-updated', function clb(e) {
        element.removeEventListener('rest-api-index-updated', clb);
        assert.isFalse(e.cancelable);
        done();
      });
      element.updateIndex(createdIndex);
    });
  });

  suite('updateIndexBatch()', function() {
    var element;

    setup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
      });
    });

    var docs = [{
      _id: 'test-1',
      title: 'test-1'
    }, {
      _id: 'test-2',
      title: 'test-2'
    }];

    test('creates two objects', function() {
      return element.updateIndexBatch(docs)
      .then(created => {
        assert.typeOf(created, 'array', 'Returns created documents');
        assert.lengthOf(created, 2, 'Created all items');
        assert.ok(created[0]._rev, '_rev (1) is set');
        assert.ok(created[1]._rev, '_rev (2) is set');
      });
    });

    test('Fires rest-api-index-updated custom event', function() {
      var spy = sinon.spy();
      element.addEventListener('rest-api-index-updated', spy);
      delete docs[0]._rev;
      delete docs[1]._rev;
      return element.updateIndexBatch(docs)
      .then(() => {
        assert.isTrue(spy.calledTwice);
      });
    });
  });

  suite('listIndex()', function() {
    var element;

    var docs = [{
      _id: 'test-1',
      title: 'test-1'
    }, {
      _id: 'test-2',
      title: 'test-2'
    }];

    setup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        delete docs[0]._rev;
        delete docs[1]._rev;
        return element.updateIndexBatch(docs);
      });
    });

    var nextPageToken;

    test('Lists index data', function() {
      return element.listIndex()
      .then(result => {
        assert.typeOf(result, 'object', 'returns an object');
        assert.typeOf(result.nextPageToken, 'string', 'nextPageToken is set');
        assert.typeOf(result.items, 'array', 'items is a list');
        assert.lengthOf(result.items, 2, 'There are two items on the list');
        nextPageToken = result.nextPageToken;
      });
    });

    test('_cachedQueryOptions contains query options for token', function() {
      return element.listIndex()
      .then(result => {
        var pageData = element._cachedQueryOptions[result.nextPageToken];
        assert.typeOf(pageData, 'object');
        assert.equal(pageData.startkey, result.items[result.items.length - 1]._id);
        assert.equal(pageData.skip, 1);
      });
    });

    test('Call with nextPageToken returns empty result', function() {
      var nextPageToken;
      return element.listIndex()
      .then(result => {
        nextPageToken = result.nextPageToken;
        return element.listIndex({
          nextPageToken: result.nextPageToken
        });
      })
      .then(result => {
        assert.equal(result.nextPageToken, nextPageToken, 'nextPageToken is the same');
        assert.lengthOf(result.items, 0, 'There is no items on list');
      });
    });
  });
});

suite('Events API', function() {
  suite('_createHandler()', function() {
    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi();
    });

    var element;
    setup(function() {
      element = fixture('basic');
    });

    test('Creates new object from event', function() {
      var event = new CustomEvent('rest-api-create', {
        detail: {
          raml: RAML
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);
      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);
      return event.detail.result
      .then(result => {
        assert.typeOf(result._rev, 'string');
      });
    });

    test('Index datastore contains one object', function() {
      return indexDb().allDocs({
        // jscs:disable
        include_docs: true
        // jscs:enable
      }).then(result => {
        assert.lengthOf(result.rows, 1);
      });
    });

    test('Data datastore contains one object', function() {
      return dataDb().allDocs().then(result => {
        assert.lengthOf(result.rows, 1);
      });
    });

    test('Creates new object with order property', function() {
      var data = Object.assign({}, RAML);
      data.title = 'test-2';
      const order = 4;
      var event = new CustomEvent('rest-api-create', {
        detail: {
          raml: data,
          order: order
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);
      return event.detail.result
      .then(result => {
        assert.strictEqual(result.order, order);
      });
    });
  });

  suite('_readHandler()', function() {
    var element;
    var created;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => created = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Reads index data', function() {
      var event = new CustomEvent('rest-api-read', {
        detail: {
          id: created._id
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);
      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(doc => {
        assert.ok(doc.raml);
      });
    });
  });

  suite('_deletedHandler()', function() {
    var element;
    var created;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi();
    });

    setup(function() {
      element = fixture('basic');
      return element.create(RAML)
      .then(doc => created = doc);
    });

    function fire(id) {
      var event = new CustomEvent('rest-api-deleted', {
        detail: {
          id: id
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);
      return event;
    }

    test('Removes the object', function() {
      var event = fire(created._id);
      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(() => {
        return indexDb().allDocs({
          // jscs:disable
          include_docs: true
          // jscs:enable
        });
      })
      .then(result => {
        assert.lengthOf(result.rows, 0, 'Index items is 0');
        return dataDb().allDocs({
          // jscs:disable
          include_docs: true
          // jscs:enable
        });
      })
      .then(result => {
        assert.lengthOf(result.rows, 0, 'Data items is 0');
      });
    });

    test('Fires rest-api-deleted event', function(done) {
      element.addEventListener('rest-api-deleted', function clb(e) {
        element.removeEventListener('rest-api-deleted', clb);
        assert.isFalse(e.cancelable);
        done();
      });
      fire(created._id);
    });
  });

  suite('_dataUpdatedHandler()', function() {
    var element;
    var createdIndex;
    var createdData;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => createdIndex = doc)
        .then(() => dataDb().get(createdIndex._id))
        .then(doc => createdData = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Updates data object', function() {
      createdData.created = 1;
      var oldRev = createdData._rev;

      var event = new CustomEvent('rest-api-data-updated', {
        detail: {
          doc: createdData
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);

      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(result => {
        createdData = result;
        assert.notEqual(result._rev, oldRev);
      });
    });
  });

  suite('_indexUpdatedHandler()', function() {
    var element;
    var createdIndex;

    suiteSetup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        return element.create(RAML)
        .then(doc => createdIndex = doc);
      });
    });

    setup(function() {
      element = fixture('basic');
    });

    test('Updates index object', function() {
      createdIndex.title = 'test-1';
      var oldRev = createdIndex._rev;
      var event = new CustomEvent('rest-api-index-updated', {
        detail: {
          doc: createdIndex
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);

      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(result => {
        createdIndex = result;
        assert.notEqual(result._rev, oldRev);
      });
    });
  });

  suite('_indexesUpdatedHandler()', function() {
    var element;

    setup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
      });
    });

    var docs = [{
      _id: 'test-1',
      title: 'test-1'
    }, {
      _id: 'test-2',
      title: 'test-2'
    }];

    test('creates two objects', function() {
      var event = new CustomEvent('rest-api-index-updated-batch', {
        detail: {
          docs: docs
        },
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);

      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(created => {
        assert.typeOf(created, 'array', 'Returns created documents');
        assert.lengthOf(created, 2, 'Created all items');
        assert.ok(created[0]._rev, '_rev (1) is set');
        assert.ok(created[1]._rev, '_rev (2) is set');
      });
    });
  });

  suite('_indexListHandler()', function() {
    var element;

    var docs = [{
      _id: 'test-1',
      title: 'test-1'
    }, {
      _id: 'test-2',
      title: 'test-2'
    }];

    setup(function() {
      return DatabaseHelper.clearRestAPi()
      .then(() => {
        element = fixture('basic');
        delete docs[0]._rev;
        delete docs[1]._rev;
        return element.updateIndexBatch(docs);
      });
    });

    var nextPageToken;

    test('Lists index data', function() {
      var event = new CustomEvent('rest-api-index-list', {
        detail: {},
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);

      assert.isTrue(event.defaultPrevented);
      assert.ok(event.detail.result);

      return event.detail.result
      .then(result => {
        assert.typeOf(result, 'object', 'returns an object');
        assert.typeOf(result.nextPageToken, 'string', 'nextPageToken is set');
        assert.typeOf(result.items, 'array', 'items is a list');
        assert.lengthOf(result.items, 2, 'There are two items on the list');
        nextPageToken = result.nextPageToken;
      });
    });

    test('Call with nextPageToken returns empty result', function() {
      var nextPageToken;
      return element.listIndex()
      .then(result => {
        nextPageToken = result.nextPageToken;

        let event = new CustomEvent('rest-api-index-list', {
          detail: {
            nextPageToken: result.nextPageToken
          },
          bubbles: true,
          cancelable: true
        });
        document.body.dispatchEvent(event);
        return event.detail.result;
      })
      .then(result => {
        assert.equal(result.nextPageToken, nextPageToken, 'nextPageToken is the same');
        assert.lengthOf(result.items, 0, 'There is no items on list');
      });
    });
  });
});
</script>

  </body>
</html>
