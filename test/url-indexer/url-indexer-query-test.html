<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../../mocha/mocha.js"></script>
    <script src="../../../../chai/chai.js"></script>
    <script src="../../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <url-indexer></url-indexer>
      </template>
    </test-fixture>

    <script type="module">
      import '../../url-indexer.js';

      suite('Query index', function() {
        function clearAllIndexes(db) {
          return new Promise((resolve, reject) => {
            const tx = db.transaction('urls', 'readwrite');
            const store = tx.objectStore('urls');
            const results = [];
            tx.onerror = () => {
              reject(results);
            };
            tx.oncomplete = () => {
              resolve(results);
            };
            store.clear();
          });
        }

        suite('Querying for data', function() {
          let element;

          suiteSetup(function() {
            element = fixture('Basic');
            const toIndex = [{
              id: 'test-id-1',
              url: 'https://domain.com/Api/Path?p1=1&p2=2',
              type: 'saved'
            }, {
              id: 'test-id-2',
              url: 'https://domain.com/',
              type: 'saved'
            }, {
              id: 'test-id-3',
              url: 'https://api.domain.com/',
              type: 'history'
            }, {
              id: 'test-id-4',
              url: 'https://api.mulesoft.com/path/to?param=1',
              type: 'history'
            }];
            return element.index(toIndex);
          });

          suiteTeardown(() => {
            return element.openSearchStore()
            .then((db) => clearAllIndexes(db));
          });

          suite('Case search', function() {
            [
              ['https:', 4, 2, 2],
              ['api', 2, 0, 2],
              ['domain.com', 3, 2, 1],
              ['mulesoft.com', 0, 0, 0]
            ].forEach(function(data) {
              test(`Querying for "${data[0]}"`, function() {
                return element.query(data[0], {detailed: false})
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[1]);
                });
              });

              test(`Querying for "${data[0]}" - saved only `, function() {
                return element.query(data[0], {
                  detailed: false,
                  type: 'saved'
                })
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[2]);
                });
              });

              test(`Querying for "${data[0]}" - history only `, function() {
                return element.query(data[0], {
                  detailed: false,
                  type: 'history'
                })
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[3]);
                });
              });
            });
          });

          suite('Detailed search', function() {
            [
              ['https:', 4, 2, 2],
              ['api', 3, 1, 2],
              ['domain.com', 3, 2, 1],
              ['mulesoft.com', 1, 0, 1]
            ].forEach(function(data) {
              test(`Querying for "${data[0]}"`, function() {
                return element.query(data[0], {detailed: true})
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[1]);
                });
              });

              test(`Querying for "${data[0]}" - saved only `, function() {
                return element.query(data[0], {
                  detailed: true,
                  type: 'saved'
                })
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[2]);
                });
              });

              test(`Querying for "${data[0]}" - history only `, function() {
                return element.query(data[0], {
                  detailed: true,
                  type: 'history'
                })
                .then((result) => {
                  assert.lengthOf(Object.keys(result), data[3]);
                });
              });
            });
          });
        });
      });
    </script>

  </body>
</html>
