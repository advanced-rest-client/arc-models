<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../../mocha/mocha.js"></script>
    <script src="../../../../chai/chai.js"></script>
    <script src="../../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <variables-model></variables-model>
      </template>
    </test-fixture>

    <script type="module">
      import {DataGenerator} from '../../../../@advanced-rest-client/arc-data-generator/arc-data-generator.js';
      import '../../variables-model.js';
      import {DataHelper} from './data-helper.js';

      suite('environment event tests', function() {
        suite('environment-deleted event', function() {
          let databaseRecordId;
          let databaseRecordRev;
          let element;
          suiteTeardown(function() {
            return DataGenerator.destroyVariablesData();
          });

          setup(function() {
            element = fixture('basic');
            return DataHelper.addEnv('test')
            .then((result) => {
              databaseRecordId = result.id;
              databaseRecordRev = result.rev;
            })
            .then(() => {
              const vars = [{
                variable: 'test',
                value: 'some variable',
                environment: 'test'
              }, {
                variable: 'test-2',
                value: 'some variable-2',
                environment: 'test'
              }];
              return DataHelper.addVars(vars);
            });
          });

          test('Cancels the event', function() {
            const e = new CustomEvent('environment-deleted', {
              bubbles: true,
              cancelable: true,
              detail: {
                id: databaseRecordId
              }
            });
            document.body.dispatchEvent(e);
            assert.isTrue(e.defaultPrevented);
            return e.detail.result.then(() => {});
          });

          test('Event promise has result data', function() {
            const e = new CustomEvent('environment-deleted', {
              bubbles: true,
              cancelable: true,
              detail: {
                id: databaseRecordId
              }
            });
            document.body.dispatchEvent(e);
            return e.detail.result
            .then((result) => {
              assert.equal(result.id, databaseRecordId, 'Has env ID');
              assert.notEqual(result.rev, databaseRecordRev, 'Has new rev');
            });
          });

          test('Dispatches environment-deleted', function(done) {
            const e = new CustomEvent('environment-deleted', {
              bubbles: true,
              cancelable: true,
              detail: {
                id: databaseRecordId
              }
            });
            document.body.dispatchEvent(e);
            element.addEventListener('environment-deleted', function(e) {
              assert.isFalse(e.cancelable);
              done();
            });
          });
        });

        suite('environment-list-variables event', function() {
          suiteTeardown(function() {
            return DataGenerator.destroyVariablesData();
          });
          setup(function() {
            fixture('basic');
          });

          test('Cancels the event', function() {
            const e = new CustomEvent('environment-list-variables', {
              bubbles: true,
              cancelable: true,
              detail: {
                environment: 'test'
              }
            });
            document.body.dispatchEvent(e);
            assert.isTrue(e.defaultPrevented);
            return e.detail.result.then(() => {});
          });

          test('Event promise has result data', function() {
            const e = new CustomEvent('environment-list-variables', {
              bubbles: true,
              cancelable: true,
              detail: {
                environment: 'test'
              }
            });
            document.body.dispatchEvent(e);
            return e.detail.result
            .then((result) => {
              assert.typeOf(result, 'array');
            });
          });
        });

        suite('environment-updated event', function() {
          suiteTeardown(function() {
            return DataGenerator.destroyVariablesData();
          });

          let element;
          let env;
          setup(function() {
            element = fixture('basic');
            env = {
              name: 'test'
            };
          });

          test('Cancels the event', function() {
            const e = new CustomEvent('environment-updated', {
              bubbles: true,
              cancelable: true,
              detail: {
                value: env
              }
            });
            document.body.dispatchEvent(e);
            assert.isTrue(e.defaultPrevented);
            return e.detail.result.then(() => {});
          });

          test('Event promise has result data', function() {
            const e = new CustomEvent('environment-updated', {
              bubbles: true,
              cancelable: true,
              detail: {
                value: env
              }
            });
            document.body.dispatchEvent(e);
            return e.detail.result
            .then((result) => {
              assert.typeOf(result._id, 'string');
              assert.typeOf(result._rev, 'string');
            });
          });

          test('Dispatches environment-updated', function(done) {
            const e = new CustomEvent('environment-updated', {
              bubbles: true,
              cancelable: true,
              detail: {
                value: env
              }
            });
            document.body.dispatchEvent(e);
            element.addEventListener('environment-updated', function f(e) {
              element.removeEventListener('environment-updated', f);
              assert.isFalse(e.cancelable);
              done();
            });
          });
        });
      });
    </script>

  </body>
</html>
