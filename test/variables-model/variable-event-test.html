<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../../mocha/mocha.js"></script>
    <script src="../../../../chai/chai.js"></script>
    <script src="../../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <variables-model></variables-model>
      </template>
    </test-fixture>

    <script type="module">
      import {DataGenerator} from '../../../../@advanced-rest-client/arc-data-generator/arc-data-generator.js';
      import sinon from '../../../../sinon/pkg/sinon-esm.js';
      import '../../variables-model.js';

      suite('variable event tests', function() {
        suite('variable-updated', function() {
          suiteTeardown(function() {
            return DataGenerator.destroyVariablesData();
          });

          let element;
          let varData;
          setup(function() {
            element = fixture('basic');
            varData = {
              name: 'test',
              variable: 'var-value',
              enabled: true
            };
          });

          test('Creates new variable', function() {
            const e = new CustomEvent('variable-updated', {
              bubbles: true,
              cancelable: true,
              detail: {
                value: varData
              }
            });
            document.body.dispatchEvent(e);
            assert.isTrue(e.defaultPrevented);
            return e.detail.result
            .then((result) => {
              assert.equal(result.name, 'test');
              assert.typeOf(result._id, 'string');
              assert.typeOf(result._rev, 'string');
            });
          });

          test('Updates existing variable', () => {
            let id;
            let rev;
            return element.updateVariable(varData)
            .then((result) => {
              id = result._id;
              rev = result._rev;
              result.enabled = false;
              const e = new CustomEvent('variable-updated', {
                bubbles: true,
                cancelable: true,
                detail: {
                  value: varData
                }
              });
              document.body.dispatchEvent(e);
              return e.detail.result;
            })
            .then((result) => {
              assert.isFalse(result.enabled);
              assert.equal(result._id, id);
              assert.notEqual(result._rev, rev);
            });
          });
        });

        suite('variable-deleted', function() {
          suiteTeardown(function() {
            return DataGenerator.destroyVariablesData();
          });

          let element;
          let varData;
          setup(function() {
            element = fixture('basic');
            varData = {
              name: 'test',
              variable: 'var-value',
              enabled: true
            };
          });

          test('Deletes variables', () => {
            return element.updateVariable(varData)
            .then((result) => {
              const e = new CustomEvent('variable-deleted', {
                bubbles: true,
                cancelable: true,
                detail: {
                  id: result._id
                }
              });
              document.body.dispatchEvent(e);
              assert.isTrue(e.defaultPrevented);
              return e.detail.result;
            })
            .then(() => DataGenerator.getDatastoreVariablesData())
            .then((result) => {
              assert.lengthOf(result, 0);
            });
          });
        });

        suite('"destroy-model" event', () => {
          function fire(models) {
            const e = new CustomEvent('destroy-model', {
              detail: {
                models
              },
              bubbles: true
            });
            document.body.dispatchEvent(e);
            return e;
          }

          test('Deletes saved model', function() {
            fixture('basic');
            const e = fire(['variables']);
            assert.typeOf(e.detail.result, 'array');
            assert.lengthOf(e.detail.result, 2);
            return Promise.all(e.detail.result);
          });

          test('Calls delete functions', function() {
            const element = fixture('basic');
            const spy1 = sinon.spy(element, '_delVariablesModel');
            const spy2 = sinon.spy(element, '_delEnvironmentsModel');
            const e = fire(['variables']);
            assert.isTrue(spy1.called);
            assert.isTrue(spy2.called);
            return Promise.all(e.detail.result);
          });
        });
      });
    </script>

  </body>
</html>
